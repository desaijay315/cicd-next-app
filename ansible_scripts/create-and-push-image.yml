---
- hosts: all
  become: true

  tasks:
    - name: Download AWS CLI bundle.
      shell: "cd /tmp && rm -rf /tmp/awscli* && curl 'https://s3.amazonaws.com/aws-cli/awscli-bundle.zip' -o 'awscli-bundle.zip'"

    - name: Update repositories cache and install "unzip" package
      apt:
        name: unzip
      update_cache: yes

    - name: Unzip AWS CLI bundle.
      shell: "cd /tmp && unzip awscli-bundle.zip"

    - name: Run AWS CLI installer.
      shell: "/tmp/awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws"

    - name: Log into aws ecr docker registry
      when: jupyterhub__notebook_registry != ''
      shell: "$(/usr/bin/aws ecr get-login --no-include-email --region us-east-1)"

    - name: remove the image
      command: docker rmi 583044482327.dkr.ecr.ap-south-1.amazonaws.com/nextjs:latest
      ignore_errors: yes

    - name: docker pull
      command: docker pull 583044482327.dkr.ecr.ap-south-1.amazonaws.com/nextjs:latest
      ignore_errors: yes

    - name: build the images
      command: docker build -t nextjs .
      args:
        chdir: /opt/docker

    - name: tag the images
      command: docker tag nextjs:latest 583044482327.dkr.ecr.ap-south-1.amazonaws.com/nextjs:latest

    - name: push the image
      command: docker push 583044482327.dkr.ecr.ap-south-1.amazonaws.com/nextjs:latest
  # - name: pull the image
  #  command: docker pull 583044482327.dkr.ecr.ap-south-1.amazonaws.com/nextjs:latest
  # - name: stop the container
  #   command: docker stop nextjs-devops-container
  #   ignore_errors: yes

  #- name: stop rm container
  #command: docker rm nextjs-devops-container
  #ignore_errors: yes

  #- name: create container using nextjs devops image
  # command: docker run -d --name nextjs-devops-container -p 8080:8080 583044482327.dkr.ecr.ap-south-1.amazonaws.com/nextjs:latest
